<!DOCTYPE html>
<html>
<head>
  <title>GhostLAN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="UTF-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
      color: #050505;
      position: fixed;
      width: 100%;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      background-color: #fff;
      position: relative;
      
    }

    /* Header Styles */
    .header {
      padding: 15px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: left;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 22px;
      margin: 0;
      flex-grow: 1;
      font-weight: 500;
    }

    .clear-button {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .clear-button:hover {
      background-color: rgba(255, 255, 255, 0.25);
    }

    .clear-button:active {
      transform: scale(0.95);
    }

    /* Chat Container */
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(180deg, #e8f4f8 0%, #f0f2f5 100%);
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    /* Message Container */
    .message-container {
      margin-bottom: 15px;
      display: flex;
      align-items: flex-end;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateY(20px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    .message-container.sent {
      justify-content: flex-end;
      margin-left: 15%;
    }

    .message-container.received {
      justify-content: flex-start;
      margin-right: 15%;
    }

    /* Avatar Styles */
    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      margin: 0 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .received .message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      order: 1;
    }

    .sent .message-avatar {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      order: 3;
    }

    /* Message Bubble */
    .message-bubble {
      max-width: 100%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      animation: bubblePop 0.3s ease;
    }

    @keyframes bubblePop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .sent .message-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 6px;
      order: 2;
    }

    .sent .message-bubble::after {
      content: '';
      position: absolute;
      right: -6px;
      bottom: 0;
      width: 0;
      height: 0;
      border-left: 6px solid #764ba2;
      border-bottom: 6px solid transparent;
    }

    .received .message-bubble {
      background-color: #ffffff;
      color: #1c1e21;
      border-bottom-left-radius: 6px;
      order: 2;
      border: 1px solid #e4e6ea;
    }

    .received .message-bubble::after {
      content: '';
      position: absolute;
      left: -7px;
      bottom: 0;
      width: 0;
      height: 0;
      border-right: 6px solid #ffffff;
      border-bottom: 6px solid transparent;
    }

    /* Message Content */
    .message-content {
      font-size: 15px;
      line-height: 1.4;
      margin-bottom: 4px;
    }

    .message-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .message-sender {
      font-size: 12px;
      font-weight: 600;
      opacity: 0.8;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.6;
      font-weight: 400;
    }

    .sent .message-info {
      justify-content: flex-end;
    }

    .received .message-info {
      justify-content: flex-start;
    }

    /* Empty Chat State */
    .empty-chat {
      text-align: center;
      color: #8a8d91;
      padding: 60px 20px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
    }

    .empty-chat .chat-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-chat svg {
      width: 40px;
      height: 40px;
      fill: white;
    }

    .empty-chat h3 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #1c1e21;
    }

    .empty-chat p {
      font-size: 14px;
      line-height: 1.5;
      color: #65676b;
    }

    /* Message Input Area */
    .input-area {
      background-color: #fff;
      padding: 16px 20px;
      border-top: 1px solid #e4e6ea;
      position: sticky;
      bottom: 0;
      width: 100%;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    .input-section {
      margin-bottom: 12px;
    }

    .input-label {
      font-size: 12px;
      color: #65676b;
      margin-bottom: 6px;
      font-weight: 500;
      display: block;
    }

    .name-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    #nameInput {
      width: 100%;
      padding: 12px 16px 12px 45px;
      border-radius: 25px;
      border: 1px solid #d0d7de;
      background-color: #f7f8fa;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    .name-icon {
      position: absolute;
      left: 15px;
      width: 18px;
      height: 18px;
      fill: #8a8d91;
      z-index: 10;
    }

    .message-input-container {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }

    #messageInput {
      flex: 1;
      padding: 12px 20px;
      border-radius: 25px;
      border: 1px solid #d0d7de;
      background-color: #f7f8fa;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background-color: #fff;
    }

    #sendButton {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
      transition: all 0.2s ease;
    }

    #sendButton:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    #sendButton:active {
      transform: translateY(0);
    }

    .send-icon {
      width: 20px;
      height: 20px;
      fill: white;
      margin-left: 2px;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      user-select: none;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: #fff;
      width: 90%;
      max-width: 320px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      padding: 20px 20px 10px;
      text-align: center;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      color: #1c1e21;
    }

    .modal-body {
      padding: 10px 20px 20px;
      text-align: center;
      color: #65676b;
      font-size: 14px;
      line-height: 1.5;
    }

    .modal-footer {
      display: flex;
      border-top: 1px solid #e4e6ea;
    }

    .modal-button {
      flex: 1;
      padding: 15px;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      background: none;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .cancel-button {
      color: #65676b;
      border-right: 1px solid #e4e6ea;
    }

    .cancel-button:hover {
      background-color: #f7f8fa;
    }

    .confirm-button {
      color: #e41e3f;
    }

    .confirm-button:hover {
      background-color: #ffeef0;
    }

    /* Responsive Design */
    @media (min-width: 768px) {
      .app-container {
        max-width: 600px;
        height: 90vh;
        margin: 5vh auto;
        border-radius: 15px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        border-radius: 15px 15px 0 0;
      }

      .input-area {
        border-radius: 0 0 15px 15px;
      }

      #chat-box {
        padding: 25px;
      }

      .message-container.sent {
        margin-left: 20%;
      }

      .message-container.received {
        margin-right: 20%;
      }
    }

    /* Scrollbar Styling */
    #chat-box::-webkit-scrollbar {
      width: 6px;
    }

    #chat-box::-webkit-scrollbar-track {
      background: transparent;
    }

    #chat-box::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    #chat-box::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <h1>GhostLAN</h1>
      <button class="clear-button" id="clearButton">Clear Chat</button>
    </div>

    <div id="chat-box">
      <div class="empty-chat" id="emptyChat">
        <div class="chat-icon">
          <svg viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
          </svg>
        </div>
        <h3>Welcome to GhostLAN!</h3>
        <p>Start your conversation by typing a message below. Your messages will appear here in real-time.</p>
      </div>
    </div>

    <div class="input-area">
      <div class="input-section">
        <div class="name-input-wrapper">
          <svg class="name-icon" viewBox="0 0 24 24">
            <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 4V6L21 9ZM15 10.26L21 7.26V9.26L15 12.26V10.26ZM12 7C16.42 7 20 8.79 20 11V13C20 15.21 16.42 17 12 17S4 15.21 4 13V11C4 8.79 7.58 7 12 7Z"/>
          </svg>
          <input type="text" id="nameInput" placeholder="Enter your name" required>
        </div>
      </div>
      
      <form id="chatForm" class="message-input-container">
        <input type="text" id="messageInput" placeholder="Type your message..." required autocomplete="off">
        <button type="submit" id="sendButton">
          <svg class="send-icon" viewBox="0 0 24 24">
            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
          </svg>
        </button>
      </form>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Clear All Messages</h3>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete all messages? This action cannot be undone and all conversation history will be permanently lost.</p>
      </div>
      <div class="modal-footer">
        <button class="modal-button cancel-button" id="cancelClear">Cancel</button>
        <button class="modal-button confirm-button" id="confirmClear">Delete All</button>
      </div>
    </div>
  </div>

  <script>
    // DOM elements
    const chatBox = document.getElementById("chat-box");
    const nameInput = document.getElementById("nameInput");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const clearButton = document.getElementById("clearButton");
    const emptyChat = document.getElementById("emptyChat");
    const confirmModal = document.getElementById("confirmModal");
    const cancelClear = document.getElementById("cancelClear");
    const confirmClear = document.getElementById("confirmClear");

    // Generate initials from name
    function getInitials(name) {
      return name
        .split(' ')
        .map(word => word[0])
        .join('')
        .toUpperCase()
        .slice(0, 2);
    }

    // Get current time formatted
    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Create message element
    function createMessageElement(name, message, timestamp, isSent = false) {
      const messageContainer = document.createElement('div');
      messageContainer.className = `message-container ${isSent ? 'sent' : 'received'}`;

      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = getInitials(name);

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      const content = document.createElement('div');
      content.className = 'message-content';
      content.textContent = message;

      const info = document.createElement('div');
      info.className = 'message-info';

      const sender = document.createElement('span');
      sender.className = 'message-sender';
      sender.textContent = isSent ? 'You' : name;

      const time = document.createElement('span');
      time.className = 'message-time';
      time.textContent = timestamp || getCurrentTime();

      info.appendChild(sender);
      info.appendChild(time);
      bubble.appendChild(content);
      bubble.appendChild(info);

      messageContainer.appendChild(avatar);
      messageContainer.appendChild(bubble);

      return messageContainer;
    }

    function formatMessages(responseText) {
      if (!responseText.trim()) {
        emptyChat.style.display = "block";
        return "";
      }
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = responseText;
      
      const userName = localStorage.getItem("chatName") || '';
      const messageElements = tempDiv.querySelectorAll('.message-line');
      
      if (messageElements.length === 0) {
        emptyChat.style.display = "block";
        return responseText;
      } else {
        emptyChat.style.display = "none";
      }
      
      // Clear the temp div and rebuild with new format
      tempDiv.innerHTML = '';
      
      messageElements.forEach(message => {
        const originalContent = message.innerHTML;
        
        // Extract name, message, and timestamp
        const strongMatch = originalContent.match(/<strong>(.*?)<\/strong>/);
        const nameText = strongMatch ? strongMatch[1] : '';
        
        const timestampMatch = originalContent.match(/<span class="timestamp">(.*?)<\/span>/);
        const timestampText = timestampMatch ? timestampMatch[1] : getCurrentTime();
        
        let messageText = '';
        if (strongMatch) {
          const afterStrong = originalContent.split('</strong>')[1] || '';
          messageText = timestampMatch ? 
            afterStrong.split('<span class="timestamp">')[0] : 
            afterStrong;
        } else {
          messageText = originalContent;
        }
        
        messageText = messageText.trim();
        
        // Determine if sent or received
        const isSent = userName && nameText && nameText.trim() === userName.trim();
        
        // Create new message element
        const newMessage = createMessageElement(nameText, messageText, timestampText, isSent);
        tempDiv.appendChild(newMessage);
      });
      
      return tempDiv.innerHTML;
    }

    function loadChat() {
      const shouldScroll = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 50;

      const xhr = new XMLHttpRequest();
      xhr.open("GET", "load.php", true);
      xhr.onload = function () {
        if (this.status === 200) {
          if (!this.responseText.trim()) {
            chatBox.innerHTML = "";
            emptyChat.style.display = "block";
            return;
          }
          
          try {
            const formattedMessages = formatMessages(this.responseText);
            
            if (!formattedMessages || formattedMessages.trim() === "") {
              chatBox.innerHTML = this.responseText;
            } else {
              chatBox.innerHTML = formattedMessages;
            }
            
            if (chatBox.querySelectorAll('.message-container').length === 0) {
              emptyChat.style.display = "block";
            } else {
              emptyChat.style.display = "none";
            }
          } catch (error) {
            console.error("Error formatting messages:", error);
            chatBox.innerHTML = this.responseText;
          }
          
          if (shouldScroll) {
            setTimeout(() => {
              chatBox.scrollTop = chatBox.scrollHeight;
            }, 100);
          }
        }
      };
      xhr.send();
    }

    function loadName() {
      const savedName = localStorage.getItem("chatName");
      if (savedName) {
        nameInput.value = savedName;
      }
    }

    function deleteChat() {
      const xhr = new XMLHttpRequest();
      xhr.open("GET", "delete.php", true);
      xhr.onload = function () {
        if (this.status === 200) {
          loadChat();
          closeModal();
        }
      };
      xhr.send();
    }

    function showModal() {
      confirmModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      confirmModal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // Event Listeners
    document.getElementById("chatForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const name = nameInput.value.trim();
      const message = messageInput.value.trim();

      if (!name || !message) {
        if (!name) nameInput.focus();
        return;
      }

      localStorage.setItem("chatName", name);

      // Add loading state
      sendButton.style.transform = "scale(0.95)";
      sendButton.style.opacity = "0.7";
      messageInput.disabled = true;
      
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "send.php", true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.onload = function () {
        if (this.status === 200) {
          messageInput.value = "";
          messageInput.disabled = false;
          messageInput.focus();
          loadChat();
        }
        sendButton.style.transform = "scale(1)";
        sendButton.style.opacity = "1";
      };
      xhr.send("name=" + encodeURIComponent(name) + "&message=" + encodeURIComponent(message));
    });

    nameInput.addEventListener("input", function () {
      localStorage.setItem("chatName", this.value);
    });

    // Auto-resize behavior
    messageInput.addEventListener('input', function() {
      if (this.value.length > 0) {
        sendButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      } else {
        sendButton.style.background = 'linear-gradient(135deg, #ccc 0%, #999 100%)';
      }
    });

    clearButton.addEventListener("click", showModal);
    cancelClear.addEventListener("click", closeModal);
    confirmClear.addEventListener("click", deleteChat);

    // Close modal when clicking outside
    confirmModal.addEventListener("click", function(e) {
      if (e.target === confirmModal) {
        closeModal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && confirmModal.classList.contains('active')) {
        closeModal();
      }
    });

    // Prevent zoom on input focus (iOS)
    document.addEventListener('touchstart', function() {}, {passive: true});

    // Initialize app
    window.addEventListener('load', function() {
      loadChat();
      loadName();
      
      // Smart focus logic
      const savedName = localStorage.getItem("chatName");
      setTimeout(() => {
        if (savedName && savedName.trim() !== "") {
          messageInput.focus();
        } else {
          nameInput.focus();
        }
      }, 300);
      
      // Polling for new messages
      setInterval(loadChat, 1000);
      
      // Initial scroll to bottom
      setTimeout(() => {
        chatBox.scrollTop = chatBox.scrollHeight;
      }, 500);
    });

    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        loadChat();
      }
    });
  </script>
</body>
</html>